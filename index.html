<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tr√≤ Ch∆°i VPIC ƒê·ªï X√∫c X·∫Øc Ch·ªçn M√≥n ƒÇn Tr∆∞a</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Fredoka+One&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #6366f1;
      --secondary: #f59e0b;
      --accent: #ec4899;
      --dark: #1e293b;
      --light: #f8fafc;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0;
      padding: 20px;
      overflow-x: hidden;
    }
    
    #app {
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      width: 100%;
      max-width: 500px;
      position: relative;
      overflow: hidden;
      border: 3px solid var(--primary);
    }
    
    #dice-container {
      width: 150px;
      height: 150px;
      margin: 0 auto;
      position: relative;
      perspective: 1000px;
    }
    
    #food-chart {
      width: 100%;
      height: 200px;
      background: #f8f9fa;
      border-radius: 10px;
      padding: 10px;
      border: 1px solid #e2e8f0;
    }
    
    #reset-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(45deg, #ff4d4d, #ff7878);
      color: white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(255, 77, 77, 0.3);
      transition: all 0.2s ease;
      z-index: 100;
    }
    
    #reset-button:hover {
      transform: scale(1.1) rotate(180deg);
      background: linear-gradient(45deg, #ff7878, #ff4d4d);
    }
    
    .btn {
      transition: all 0.3s ease;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .screen {
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    
    .screen.hidden {
      opacity: 0;
      transform: translateY(20px);
      pointer-events: none;
      position: absolute;
      width: 100%;
    }
    
    .list-item {
      transition: all 0.3s ease;
      background: white;
      margin-bottom: 8px;
    }
    
    .list-item:hover {
      background-color: #f1f5f9;
      transform: translateX(5px);
    }
    
    h1, h2 {
      color: var(--dark);
      font-family: 'Fredoka One', cursive;
    }
    
    h1 {
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    
    input, button {
      border-radius: 10px !important;
    }
    
    input {
      border: 2px solid #e2e8f0 !important;
    }
    
    input:focus {
      border-color: var(--primary) !important;
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3) !important;
    }
    
    /* Hi·ªáu ·ª©ng nh·∫•p nh√°y */
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    
    .blink {
      animation: blink 2s infinite;
    }
    
    /* Hi·ªáu ·ª©ng ph√°o gi·∫•y */
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: #f00;
      opacity: 0;
      z-index: 10;
    }
    
    @keyframes confetti-fall {
      0% {
        transform: translateY(-100px) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(1000px) rotate(360deg);
        opacity: 0;
      }
    }
    
    /* Hi·ªáu ·ª©ng n·∫£y */
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    
    .bounce {
      animation: bounce 0.5s ease infinite;
    }
    
    /* Hi·ªáu ·ª©ng l·∫Øc */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    .shake {
      animation: shake 0.3s ease infinite;
    }
    
    /* Hi·ªáu ·ª©ng n·ªÅn */
    .floating-bg {
      position: absolute;
      opacity: 0.1;
      z-index: -1;
    }
    
    /* Hi·ªáu ·ª©ng s√≥ng */
    .wave {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 100px;
      background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 1200 120" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none"><path d="M0,0V46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5C438.64,32.43,512.34,53.67,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1113-14.29,1200,52.47V0Z" fill="%236366f1" opacity=".25"/><path d="M0,0V15.81C13,36.92,27.64,56.86,47.69,72.05,99.41,111.27,165,111,224.58,91.58c31.15-10,59.54-26.24,84.52-46.25,34.07-27.02,55.56-51.37,80.8-76.6C466.67,3,526.85,22.82,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1113-14.29,1200,52.47V0Z" fill="%236366f1" opacity=".5"/><path d="M0,0V5.63C149.93,59,314.09,71.32,475.83,42.57c43-7.64,84.23-20.12,127.61-26.46,59-8.63,112.48,12.24,165.56,35.4C827.93,77.22,886,95.24,951.2,90c86.53-7,172.46-45.71,248.8-84.81V0Z" fill="%236366f1"/></svg>');
      background-size: cover;
      animation: wave 10s linear infinite;
    }
    
    @keyframes wave {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
    
    /* Hi·ªáu ·ª©ng n·ªÅn ƒë·ªông */
    .floating-food {
      position: absolute;
      font-size: 24px;
      opacity: 0.1;
      animation: float 15s linear infinite;
      z-index: -1;
    }
    
    @keyframes float {
      0% {
        transform: translateY(0) rotate(0deg);
        left: -50px;
      }
      100% {
        transform: translateY(-500px) rotate(360deg);
        left: calc(100% + 50px);
      }
    }
    
    /* Hi·ªáu ·ª©ng chuy·ªÉn m√†n h√¨nh */
    @keyframes slideIn {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .slide-in {
      animation: slideIn 0.5s ease forwards;
    }
    
    /* Hi·ªáu ·ª©ng xoay */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .spin {
      animation: spin 1s linear infinite;
    }
    
    /* Hi·ªáu ·ª©ng nh·∫£y */
    @keyframes jump {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    .jump {
      animation: jump 0.5s ease infinite;
    }
    
    /* Hi·ªáu ·ª©ng n·ªï */
    @keyframes explode {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(10); opacity: 0; }
    }
    
    .explode {
      animation: explode 0.5s ease forwards;
    }

    /* Food list item layout */
    .food-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: white;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .food-item:hover {
      background-color: #f1f5f9;
    }

    .food-details {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Expense item layout */
    .expense-item {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 10px;
    }

    .expense-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .expense-actions {
      display: flex;
      gap: 5px;
    }

    /* CSS cho x√∫c x·∫Øc 3D */
    .dice {
      width: 100px;
      height: 100px;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 1s;
      margin: 25px auto;
    }

    .dice-face {
      position: absolute;
      width: 100px;
      height: 100px;
      background-color: white;
      border: 2px solid #333;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .dot {
      width: 20px;
      height: 20px;
      background-color: black;
      border-radius: 50%;
    }

    .face-1 { transform: rotateY(0deg) translateZ(50px); }
    .face-2 { transform: rotateY(90deg) translateZ(50px); }
    .face-3 { transform: rotateY(180deg) translateZ(50px); }
    .face-4 { transform: rotateY(-90deg) translateZ(50px); }
    .face-5 { transform: rotateX(90deg) translateZ(50px); }
    .face-6 { transform: rotateX(-90deg) translateZ(50px); }

    /* Hi·ªáu ·ª©ng lƒÉn x√∫c x·∫Øc */
    .roll-1 { transform: translateZ(-50px) rotateY(0deg); }
    .roll-2 { transform: translateZ(-50px) rotateY(-90deg); }
    .roll-3 { transform: translateZ(-50px) rotateY(-180deg); }
    .roll-4 { transform: translateZ(-50px) rotateY(90deg); }
    .roll-5 { transform: translateZ(-50px) rotateX(-90deg); }
    .roll-6 { transform: translateZ(-50px) rotateX(90deg); }

    /* Hi·ªáu ·ª©ng lƒÉn ng·∫´u nhi√™n */
    @keyframes rollDice {
      0% { transform: translateZ(-50px) rotateX(0deg) rotateY(0deg); }
      50% { transform: translateZ(-50px) rotateX(720deg) rotateY(720deg); }
      100% { transform: translateZ(-50px) rotateX(0deg) rotateY(0deg); }
    }

    .rolling {
      animation: rollDice 1s ease-in-out;
    }
  </style>
</head>
<body>
  <!-- Hi·ªáu ·ª©ng n·ªÅn -->
  <div class="floating-bg" style="top: 10%; left: 5%; font-size: 50px;">üçú</div>
  <div class="floating-bg" style="top: 30%; left: 80%; font-size: 60px;">üç≤</div>
  <div class="floating-bg" style="top: 70%; left: 15%; font-size: 40px;">üçõ</div>
  <div class="floating-bg" style="top: 20%; left: 60%; font-size: 70px;">üç±</div>
  
  <!-- Hi·ªáu ·ª©ng s√≥ng -->
  <div class="wave"></div>
  
  <div id="app">
    <!-- M√†n h√¨nh ƒëƒÉng nh·∫≠p -->
    <div id="login-screen" class="screen space-y-6 slide-in">
      <div class="text-center">
        <i class="fas fa-utensils text-5xl text-purple-500 mb-4 jump" style="text-shadow: 0 4px 8px rgba(0,0,0,0.1);"></i>
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-2">B·ªÆA TR∆ØA VUI V·∫∫</h1>
        <h2 class="text-2xl font-bold text-center text-purple-600 mb-4">C√ôNG VPIC </h2>
        <p class="blink text-sm italic text-center text-yellow-500">M·ªôt con game "B·ªë ƒê·ªùi" do Mr. √Ånh #07897 ph√°t tri·ªÉn üòé</p>
      </div>
      
      <div class="relative">
        <input id="player-name" type="text" placeholder="N√©m c√°i t√™n c√∫ng c∆°m v√†o ƒë√¢y" 
               class="w-full p-4 border-2 border-gray-300 focus:ring-2 focus:ring-blue-400 focus:outline-none text-lg">
        <i class="fas fa-user absolute right-3 top-4 text-gray-400"></i>
      </div>
      
      <button onclick="login()" class="btn w-full bg-gradient-to-r from-purple-500 to-blue-500 text-white p-4 rounded-lg hover:from-purple-600 hover:to-blue-600 text-lg font-bold">
        <i class="fas fa-play mr-2"></i> B·∫Øt ƒê·∫ßu Th·ª≠ V·∫≠n May
      </button>
      
      <div class="text-center text-gray-500 text-sm mt-4">
        <p>Khi c√°c con d·ªùi ch√°n c∆°m th√®m ...!</p>
        <p class="mt-2 animate__animated animate__pulse animate__infinite">üëÜ Ng·∫°i c√°i v·∫πo g√¨ m√† kh√¥ng tri·ªÉn üòã üëÜ</p>
      </div>
    </div>

    <!-- M√†n h√¨nh ch√≠nh -->
    <div id="main-screen" class="screen hidden space-y-6">
      <div class="text-center">
        <i class="fas fa-dice text-4xl text-purple-500 mb-2"></i>
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">TH√äM M√ìN & ƒê·ªî X√öC X·∫ÆC</h1>
        <p class="text-xl text-purple-600 font-semibold">QUY·∫æT ƒê·ªäNH B·ªÆA TR∆ØA B·∫∞NG NH√ÇN PH·∫®M</p>
      </div>
      
      <p id="welcome-message" class="text-center text-gray-600 text-lg"></p>
      
      <div class="bg-purple-50 p-4 rounded-xl border-2 border-purple-100">
        <div id="dice-container" class="relative">
          <div class="dice" id="dice">
            <div class="dice-face face-1">
              <div class="dot"></div>
            </div>
            <div class="dice-face face-2">
              <div class="dot" style="position: absolute; top: 20px; left: 20px;"></div>
              <div class="dot" style="position: absolute; bottom: 20px; right: 20px;"></div>
            </div>
            <div class="dice-face face-3">
              <div class="dot" style="position: absolute; top: 20px; left: 20px;"></div>
              <div class="dot"></div>
              <div class="dot" style="position: absolute; bottom: 20px; right: 20px;"></div>
            </div>
            <div class="dice-face face-4">
              <div class="dot" style="position: absolute; top: 20px; left: 20px;"></div>
              <div class="dot" style="position: absolute; top: 20px; right: 20px;"></div>
              <div class="dot" style="position: absolute; bottom: 20px; left: 20px;"></div>
              <div class="dot" style="position: absolute; bottom: 20px; right: 20px;"></div>
            </div>
            <div class="dice-face face-5">
              <div class="dot" style="position: absolute; top: 20px; left: 20px;"></div>
              <div class="dot" style="position: absolute; top: 20px; right: 20px;"></div>
              <div class="dot"></div>
              <div class="dot" style="position: absolute; bottom: 20px; left: 20px;"></div>
              <div class="dot" style="position: absolute; bottom: 20px; right: 20px;"></div>
            </div>
            <div class="dice-face face-6">
              <div class="dot" style="position: absolute; top: 20px; left: 20px;"></div>
              <div class="dot" style="position: absolute; top: 20px; right: 20px;"></div>
              <div class="dot" style="position: absolute; top: 50%; left: 20px;"></div>
              <div class="dot" style="position: absolute; top: 50%; right: 20px;"></div>
              <div class="dot" style="position: absolute; bottom: 20px; left: 20px;"></div>
              <div class="dot" style="position: absolute; bottom: 20px; right: 20px;"></div>
            </div>
          </div>
        </div>
        <button onclick="rollDice()" class="btn w-full bg-gradient-to-r from-green-500 to-teal-500 text-white p-4 rounded-lg hover:from-green-600 hover:to-teal-600 text-lg font-bold mt-4">
          <i class="fas fa-random mr-2"></i> ƒê·ªï X√∫c X·∫Øc
        </button>
        <p id="roll-count" class="text-center text-sm text-gray-500 mt-2"></p>
      </div>
      
      <div id="result" class="text-center font-bold text-2xl text-purple-700 p-4 bg-purple-50 rounded-xl"></div>
      
      <div class="space-y-3 bg-yellow-50 p-4 rounded-xl border-2 border-yellow-100">
        <h2 class="text-xl font-semibold text-gray-700 flex items-center">
          <i class="fas fa-plus-circle text-yellow-500 mr-2"></i> Th√™m M√≥n ƒÇn M·ªõi
        </h2>
        <div class="flex space-x-2">
          <input id="new-food" type="text" placeholder="Nh·∫≠p t√™n m√≥n ƒÉn" 
                 class="flex-1 p-3 border-2 border-gray-300 focus:ring-2 focus:ring-purple-400 focus:outline-none">
          <button onclick="addFood()" class="btn bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-6 rounded-lg hover:from-yellow-600 hover:to-orange-600">
            <i class="fas fa-plus"></i>
          </button>
        </div>
      </div>
      
      <div class="bg-blue-50 p-4 rounded-xl border-2 border-blue-100">
        <h2 class="text-xl font-semibold text-gray-700 flex items-center">
          <i class="fas fa-list-ul text-blue-500 mr-2"></i> Danh S√°ch M√≥n ƒÇn
        </h2>
        <ul id="food-list" class="space-y-2 mt-2"></ul>
      </div>
      
      <div class="bg-green-50 p-4 rounded-xl border-2 border-green-100">
        <h2 class="text-xl font-semibold text-gray-700 flex items-center">
          <i class="fas fa-history text-green-500 mr-2"></i> L·ªãch S·ª≠ Ch·ªçn M√≥n
        </h2>
        <ul id="history" class="space-y-2 mt-2"></ul>
      </div>
      
      <div class="bg-pink-50 p-4 rounded-xl border-2 border-pink-100">
        <h2 class="text-xl font-semibold text-gray-700 flex items-center">
          <i class="fas fa-chart-bar text-pink-500 mr-2"></i> Th·ªëng K√™ M√≥n ƒÇn
        </h2>
        <p id="most-selected-food" class="blink text-lg font-bold text-center text-red-600 bg-yellow-100 p-3 rounded-lg mt-2"></p>
        <div class="flex space-x-3 mt-3">
          <button onclick="showTop5Foods()" class="btn flex-1 bg-gradient-to-r from-gray-600 to-gray-700 text-white p-2 rounded-lg hover:from-gray-700 hover:to-gray-800">
            <i class="fas fa-trophy mr-2"></i> Top 5 M√≥n
          </button>
          <button onclick="showAllFoods()" class="btn flex-1 bg-gradient-to-r from-gray-600 to-gray-700 text-white p-2 rounded-lg hover:from-gray-700 hover:to-gray-800">
            <i class="fas fa-bars mr-2"></i> Hi·ªÉn Th·ªã T·∫•t C·∫£
          </button>
        </div>
        <canvas id="food-chart" class="mt-3"></canvas>
      </div>
      
      <div class="flex space-x-3">
        <button onclick="goToFinance()" class="btn flex-1 bg-gradient-to-r from-yellow-500 to-yellow-600 text-white p-3 rounded-lg hover:from-yellow-600 hover:to-yellow-700 text-lg font-bold">
          <i class="fas fa-money-bill-wave mr-2"></i> T·ªîNG THI·ªÜT H·∫†I üí∏
        </button>
      </div>
      
      <div id="reset-button" onclick="resetGame()" title="L√†m m·ªõi">
        <i class="fas fa-sync-alt text-white text-xl"></i>
      </div>
    </div>

    <!-- M√†n h√¨nh thu chi -->
    <div id="finance-screen" class="screen hidden space-y-6">
      <div class="text-center">
        <i class="fas fa-money-bill-wave text-4xl text-green-500 mb-4"></i>
        <h1 class="text-3xl font-bold text-center text-gray-800">LI·ªÜT K√ä H·∫¨U QU·∫¢</h1>
        <p class="text-gray-600">Ghi l·∫°i c√°c kho·∫£n chi ph√≠ cho b·ªØa tr∆∞a</p>
      </div>
      
      <div class="space-y-3 bg-blue-50 p-4 rounded-xl border-2 border-blue-100">
        <div class="flex items-center space-x-2">
          <i class="fas fa-pencil-alt text-blue-500"></i>
          <input id="expense-description" type="text" placeholder="M√¥ t·∫£ nguy√™n v·∫≠t li·ªáu" 
                 class="flex-1 p-3 border-2 border-gray-300 focus:ring-2 focus:ring-purple-400 focus:outline-none">
        </div>
        
        <div class="flex items-center space-x-2">
          <i class="fas fa-money-bill-wave text-blue-500"></i>
          <input id="expense-amount" type="number" placeholder="S·ªë ti·ªÅn (VND)" 
                 class="flex-1 p-3 border-2 border-gray-300 focus:ring-2 focus:ring-purple-400 focus:outline-none">
        </div>
        
        <button onclick="addExpense()" class="btn w-full bg-gradient-to-r from-purple-500 to-blue-500 text-white p-3 rounded-lg hover:from-purple-600 hover:to-blue-600">
          <i class="fas fa-plus mr-2"></i> Th√™m Chi Ph√≠
        </button>
      </div>
      
      <div class="bg-yellow-50 p-4 rounded-xl border-2 border-yellow-100">
        <div class="flex items-center space-x-2">
          <i class="fas fa-users text-yellow-500"></i>
          <input id="number-of-participants" type="number" placeholder="S·ªë ng∆∞·ªùi tham gia ƒÉn" 
                 class="flex-1 p-3 border-2 border-gray-300 focus:ring-2 focus:ring-blue-400 focus:outline-none" min="1">
        </div>
      </div>
      
      <div class="bg-green-50 p-4 rounded-xl border-2 border-green-100">
        <h2 class="text-xl font-semibold text-gray-700 flex items-center">
          <i class="fas fa-chart-pie text-green-500 mr-2"></i> Th·ªëng K√™ Thu Chi
        </h2>
        <ul id="expense-list" class="space-y-2 mt-3"></ul>
        
        <div class="mt-4 p-3 bg-white rounded-lg shadow">
          <p id="total-expense" class="text-center font-bold text-gray-800 text-xl"></p>
          <p id="per-person-expense" class="text-center font-medium text-gray-600 mt-2"></p>
        </div>
      </div>
      
      <button onclick="goToMain()" class="btn w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white p-3 rounded-lg hover:from-blue-600 hover:to-blue-700">
        <i class="fas fa-arrow-left mr-2"></i> Quay L·∫°i
      </button>
    </div>
  </div>

  <script>
    const socket = io('https://treasure-rightful-scallion.glitch.me');

    let playerName = '';
    let foods = [];
    let history = [];
    let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
    let foodResults = {};
    let foodChart;
    let showingTop5 = false;
    let isRolling = false;
    let rollCount = parseInt(localStorage.getItem(`rollCount_${playerName}`)) || 0;

    // Nh·∫≠n d·ªØ li·ªáu ban ƒë·∫ßu t·ª´ server
    socket.on('initData', (data) => {
      foods = data.foods;
      history = data.history;
      foodResults = data.foodResults;
      updateFoodList();
      updateHistory();
      updateRollCount();
      if (foodChart) {
        updateFoodChart();
      }
    });

    // Nh·∫≠n c·∫≠p nh·∫≠t t·ª´ server
    socket.on('updateFoods', (newFoods) => {
      foods = newFoods;
      updateFoodList();
      updateFoodChart();
    });

    socket.on('updateHistory', (newHistory) => {
      history = newHistory;
      updateHistory();
    });

    socket.on('updateFoodResults', (newFoodResults) => {
      foodResults = newFoodResults;
      updateFoodChart();
    });

    // Kh·ªüi t·∫°o foodResults
    function initFoodResults() {
      foods.forEach(food => {
        if (!(food.name in foodResults)) {
          foodResults[food.name] = 0;
        }
      });
    }

    // Hi·ªáu ·ª©ng lƒÉn x√∫c x·∫Øc CSS
    function rollDiceAnimation(face) {
      if (isRolling) return;
      isRolling = true;

      const dice = document.getElementById('dice');
      dice.classList.remove('roll-1', 'roll-2', 'roll-3', 'roll-4', 'roll-5', 'roll-6');
      dice.classList.add('rolling');

      setTimeout(() => {
        dice.classList.add(`roll-${face}`);
        isRolling = false;
      }, 1000);
    }

    // ƒê·ªï x√∫c x·∫Øc v·ªõi hi·ªáu ·ª©ng v√† gi·ªõi h·∫°n
    function rollDice() {
      if (foods.length === 0) {
        // Hi·ªáu ·ª©ng l·∫Øc khi kh√¥ng c√≥ m√≥n ƒÉn
        const btn = document.querySelector('[onclick="rollDice()"]');
        btn.classList.add('animate__animated', 'animate__shakeX');
        setTimeout(() => {
          btn.classList.remove('animate__animated', 'animate__shakeX');
        }, 1000);
        alert('H√£y th√™m √≠t nh·∫•t m·ªôt m√≥n ƒÉn!');
        return;
      }
      if (rollCount >= 2) {
        // Hi·ªáu ·ª©ng l·∫Øc khi v∆∞·ª£t gi·ªõi h·∫°n
        const btn = document.querySelector('[onclick="rollDice()"]');
        btn.classList.add('animate__animated', 'animate__shakeX');
        setTimeout(() => {
          btn.classList.remove('animate__animated', 'animate__shakeX');
        }, 1000);
        alert('B·∫°n ƒë√£ h·∫øt l∆∞·ª£t ƒë·ªï x√∫c x·∫Øc! Gi·ªõi h·∫°n l√† 2 l·∫ßn.');
        return;
      }

      const randomFace = Math.floor(Math.random() * 6) + 1;
      rollDiceAnimation(randomFace);
      rollCount++;
      localStorage.setItem(`rollCount_${playerName}`, rollCount);
      updateRollCount();
      setTimeout(() => {
        const randomIndex = Math.floor(Math.random() * foods.length);
        const selectedFood = foods[randomIndex].name;
        foodResults[selectedFood] = (foodResults[selectedFood] || 0) + 1;
        history.push(`${selectedFood} (b·ªüi ${playerName})`);
        document.getElementById('result').textContent = `M√≥n ƒÉn b·∫°n ch·ªçn tr√∫ng l√†: ${selectedFood}`;
        document.getElementById('result').classList.add('animate__animated', 'animate__bounceIn');

        // Hi·ªáu ·ª©ng ph√°o gi·∫•y
        createConfetti();

        // Hi·ªáu ·ª©ng icon nh·∫£y
        const diceIcon = document.querySelector('#main-screen .fa-dice');
        diceIcon.classList.add('animate__animated', 'animate__rubberBand');
        setTimeout(() => {
          diceIcon.classList.remove('animate__animated', 'animate__rubberBand');
        }, 1000);

        socket.emit('updateHistory', history);
        socket.emit('updateFoodResults', foodResults);
      }, 1000);
    }

    // C·∫≠p nh·∫≠t s·ªë l·∫ßn ƒë·ªï x√∫c x·∫Øc
    function updateRollCount() {
      const rollCountElement = document.getElementById('roll-count');
      rollCountElement.textContent = `S·ªë l·∫ßn ƒë·ªï c√≤n l·∫°i: ${2 - rollCount}/2`;
      if (rollCount >= 2) {
        rollCountElement.classList.add('text-red-500');
      } else {
        rollCountElement.classList.remove('text-red-500');
      }
    }

    // Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì m√≥n ƒÉn
    function initFoodChart() {
      const ctx = document.getElementById('food-chart').getContext('2d');
      foodChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(foodResults),
          datasets: [{
            label: 'S·ªë l·∫ßn ƒë∆∞·ª£c ch·ªçn',
            data: Object.values(foodResults),
            backgroundColor: [
              'rgba(255, 99, 132, 0.7)',
              'rgba(54, 162, 235, 0.7)',
              'rgba(255, 206, 86, 0.7)',
              'rgba(75, 192, 192, 0.7)',
              'rgba(153, 102, 255, 0.7)',
              'rgba(255, 159, 64, 0.7)'
            ].slice(0, Object.keys(foodResults).length),
            borderColor: [
              'rgba(255, 99, 132, 1)',
              'rgba(54, 162, 235, 1)',
              'rgba(255, 206, 86, 1)',
              'rgba(75, 192, 192, 1)',
              'rgba(153, 102, 255, 1)',
              'rgba(255, 159, 64, 1)'
            ].slice(0, Object.keys(foodResults).length),
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'S·ªë l·∫ßn ƒë∆∞·ª£c ch·ªçn',
                font: { family: 'Poppins', size: 14 }
              }
            },
            x: {
              title: {
                display: true,
                text: 'M√≥n ƒÉn',
                font: { family: 'Poppins', size: 14 }
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: true,
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.raw} l·∫ßn`;
                }
              }
            }
          }
        }
      });
    }

    // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì m√≥n ƒÉn v√† th√¥ng b√°o m√≥n ƒÉn ƒë∆∞·ª£c ch·ªçn nhi·ªÅu nh·∫•t
    function updateFoodChart() {
      let labels = Object.keys(foodResults);
      let data = Object.values(foodResults);

      if (showingTop5) {
        const sortedFoods = Object.entries(foodResults)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);
        labels = sortedFoods.map(entry => entry[0]);
        data = sortedFoods.map(entry => entry[1]);
      }

      foodChart.data.labels = labels;
      foodChart.data.datasets[0].data = data;
      foodChart.data.datasets[0].backgroundColor = [
        'rgba(255, 99, 132, 0.7)',
        'rgba(54, 162, 235, 0.7)',
        'rgba(255, 206, 86, 0.7)',
        'rgba(75, 192, 192, 0.7)',
        'rgba(153, 102, 255, 0.7)',
        'rgba(255, 159, 64, 0.7)'
      ].slice(0, labels.length);
      foodChart.data.datasets[0].borderColor = [
        'rgba(255, 99, 132, 1)',
        'rgba(54, 162, 235, 1)',
        'rgba(255, 206, 86, 1)',
        'rgba(75, 192, 192, 1)',
        'rgba(153, 102, 255, 1)',
        'rgba(255, 159, 64, 1)'
      ].slice(0, labels.length);
      foodChart.update();

      // C·∫≠p nh·∫≠t th√¥ng b√°o m√≥n ƒÉn ƒë∆∞·ª£c ch·ªçn nhi·ªÅu nh·∫•t
      const mostSelectedFood = Object.entries(foodResults)
        .sort((a, b) => b[1] - a[1])[0];
      const mostSelectedMessage = mostSelectedFood && mostSelectedFood[1] > 0
        ? `M√≥n ƒÉn ƒë∆∞·ª£c ch·ªçn tr√∫ng nhi·ªÅu nh·∫•t cho b·ªØa tr∆∞a mai l√† ${mostSelectedFood[0]} üéâ`
        : 'Ch∆∞a c√≥ m√≥n ƒÉn n√†o ƒë∆∞·ª£c ch·ªçn.';
      document.getElementById('most-selected-food').textContent = mostSelectedMessage;
    }

    // Hi·ªÉn th·ªã top 5 m√≥n ƒÉn
    function showTop5Foods() {
      showingTop5 = true;
      updateFoodChart();
    }

    // Hi·ªÉn th·ªã t·∫•t c·∫£ m√≥n ƒÉn
    function showAllFoods() {
      showingTop5 = false;
      updateFoodChart();
    }

    // M√†n h√¨nh ƒëƒÉng nh·∫≠p
    function login() {
      const nameInput = document.getElementById('player-name').value.trim();
      if (nameInput) {
        playerName = nameInput;
        rollCount = parseInt(localStorage.getItem(`rollCount_${playerName}`)) || 0;
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-screen').classList.remove('hidden');
        document.getElementById('welcome-message').textContent = `Ch√†o ${playerName}!`;
        initFoodResults();
        updateFoodList();
        updateHistory();
        updateRollCount();
        initFoodChart();
        updateFoodChart();
        
        // Hi·ªáu ·ª©ng chuy·ªÉn m√†n h√¨nh
        document.getElementById('main-screen').classList.add('animate__animated', 'animate__fadeIn');
      } else {
        // Hi·ªáu ·ª©ng l·∫Øc khi kh√¥ng nh·∫≠p t√™n
        const input = document.getElementById('player-name');
        input.classList.add('animate__animated', 'animate__shakeX');
        setTimeout(() => {
          input.classList.remove('animate__animated', 'animate__shakeX');
        }, 1000);
        alert('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!');
      }
    }

    // C·∫≠p nh·∫≠t danh s√°ch m√≥n ƒÉn
    function updateFoodList() {
      const foodList = document.getElementById('food-list');
      foodList.innerHTML = '';
      foods.forEach((food, index) => {
        const li = document.createElement('li');
        li.className = 'food-item';
        li.innerHTML = `
          <div class="food-details">
            <i class="fas fa-utensils text-purple-500 mr-2"></i>
            <span class="font-medium">${food.name}</span>
            <span class="text-sm text-gray-500 ml-2">(b·ªüi ${food.addedBy})</span>
          </div>
          <button onclick="deleteFood(${index})" class="btn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded-lg">
            <i class="fas fa-trash"></i>
          </button>
        `;
        li.classList.add('animate__animated', 'animate__fadeIn');
        foodList.appendChild(li);
      });
    }

    // X√≥a m√≥n ƒÉn
    function deleteFood(index) {
      const foodToDelete = foods[index].name;
      
      // Hi·ªáu ·ª©ng x√≥a
      const item = document.getElementById('food-list').children[index];
      item.classList.add('animate__animated', 'animate__hinge');
      
      setTimeout(() => {
        foods.splice(index, 1);
        history = history.filter(entry => {
          const match = entry.match(/(.+?) \(b·ªüi (.+)\)/);
          return match ? match[1] !== foodToDelete : true;
        });
        delete foodResults[foodToDelete];

        socket.emit('updateFoods', foods);
        socket.emit('updateHistory', history);
        socket.emit('updateFoodResults', foodResults);

        if (document.getElementById('result').textContent.includes(foodToDelete)) {
          document.getElementById('result').textContent = '';
        }
      }, 1000);
    }

    // T·∫°o hi·ªáu ·ª©ng ph√°o gi·∫•y
    function createConfetti() {
      const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
      const app = document.getElementById('app');
      
      for (let i = 0; i < 100; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.top = -10 + 'px';
        confetti.style.width = Math.random() * 10 + 5 + 'px';
        confetti.style.height = confetti.style.width;
        confetti.style.borderRadius = '50%';
        confetti.style.animation = `confetti-fall ${Math.random() * 3 + 2}s linear forwards`;
        app.appendChild(confetti);
        
        // X√≥a sau khi hi·ªáu ·ª©ng k·∫øt th√∫c
        setTimeout(() => {
          confetti.remove();
        }, 5000);
      }
    }

    // C·∫≠p nh·∫≠t l·ªãch s·ª≠
    function updateHistory() {
      const historyList = document.getElementById('history');
      historyList.innerHTML = '';
      history.forEach(item => {
        const li = document.createElement('li');
        li.className = 'list-item p-3 rounded-lg bg-white shadow-sm flex items-center';
        li.innerHTML = `
          <i class="fas fa-check-circle text-green-500 mr-3"></i>
          <span>${item}</span>
        `;
        li.classList.add('animate__animated', 'animate__fadeIn');
        historyList.appendChild(li);
      });
    }

    // Th√™m m√≥n ƒÉn
    function addFood() {
      const newFood = document.getElementById('new-food').value.trim();
      if (newFood) {
        if (foods.some(food => food.name === newFood)) {
          // Hi·ªáu ·ª©ng l·∫Øc khi m√≥n ƒÉn ƒë√£ t·ªìn t·∫°i
          const input = document.getElementById('new-food');
          input.classList.add('animate__animated', 'animate__shakeX');
          setTimeout(() => {
            input.classList.remove('animate__animated', 'animate__shakeX');
          }, 1000);
          alert('M√≥n ƒÉn n√†y ƒë√£ c√≥ trong danh s√°ch!');
          return;
        }
        const foodEntry = { name: newFood, addedBy: playerName };
        foods.push(foodEntry);
        if (!(newFood in foodResults)) {
          foodResults[newFood] = 0;
        }
        document.getElementById('new-food').value = '';

        // Hi·ªáu ·ª©ng th√™m th√†nh c√¥ng
        const addBtn = document.querySelector('[onclick="addFood()"]');
        addBtn.classList.add('animate__animated', 'animate__pulse');
        setTimeout(() => {
          addBtn.classList.remove('animate__animated', 'animate__pulse');
        }, 500);

        socket.emit('updateFoods', foods);
        socket.emit('updateFoodResults', foodResults);
      } else {
        // Hi·ªáu ·ª©ng l·∫Øc khi kh√¥ng nh·∫≠p t√™n m√≥n
        const input = document.getElementById('new-food');
        input.classList.add('animate__animated', 'animate__shakeX');
        setTimeout(() => {
          input.classList.remove('animate__animated', 'animate__shakeX');
        }, 1000);
        alert('Vui l√≤ng nh·∫≠p t√™n m√≥n ƒÉn!');
      }
    }

    // L√†m m·ªõi game
    function resetGame() {
      // Hi·ªáu ·ª©ng xoay n√∫t reset
      const resetBtn = document.getElementById('reset-button');
      resetBtn.classList.add('spin');
      
      setTimeout(() => {
        foods = [];
        history = [];
        expenses = [];
        foodResults = {};
        rollCount = 0;
        localStorage.setItem(`rollCount_${playerName}`, rollCount);
        
        socket.emit('updateFoods', foods);
        socket.emit('updateHistory', history);
        socket.emit('updateFoodResults', foodResults);

        localStorage.setItem('expenses', JSON.stringify(expenses));
        document.getElementById('result').textContent = '';
        updateRollCount();
        resetBtn.classList.remove('spin');
        location.reload();
      }, 1000);
    }

    // Chuy·ªÉn sang m√†n h√¨nh thu chi
    function goToFinance() {
      document.getElementById('main-screen').classList.add('hidden');
      document.getElementById('finance-screen').classList.remove('hidden');
      updateExpenseList();
      
      // Hi·ªáu ·ª©ng chuy·ªÉn m√†n h√¨nh
      document.getElementById('finance-screen').classList.add('animate__animated', 'animate__fadeIn');
    }

    // Quay l·∫°i m√†n h√¨nh ch√≠nh
    function goToMain() {
      document.getElementById('finance-screen').classList.add('hidden');
      document.getElementById('main-screen').classList.remove('hidden');
      updateFoodChart();
      
      // Hi·ªáu ·ª©ng chuy·ªÉn m√†n h√¨nh
      document.getElementById('main-screen').classList.add('animate__animated', 'animate__fadeIn');
    }

    // ƒê·ªãnh d·∫°ng s·ªë ti·ªÅn v·ªõi d·∫•u ch·∫•m ph√¢n c√°ch
    function formatNumber(number) {
      return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    // Th√™m chi ph√≠
    function addExpense() {
      const description = document.getElementById('expense-description').value.trim();
      const amount = parseFloat(document.getElementById('expense-amount').value);
      if (description && amount > 0) {
        expenses.push({ description, amount });
        document.getElementById('expense-description').value = '';
        document.getElementById('expense-amount').value = '';
        
        // Hi·ªáu ·ª©ng th√™m th√†nh c√¥ng
        const addBtn = document.querySelector('[onclick="addExpense()"]');
        addBtn.classList.add('animate__animated', 'animate__pulse');
        setTimeout(() => {
          addBtn.classList.remove('animate__animated', 'animate__pulse');
        }, 500);
        
        updateExpenseList();
        localStorage.setItem('expenses', JSON.stringify(expenses));
      } else {
        // Hi·ªáu ·ª©ng l·∫Øc khi kh√¥ng nh·∫≠p ƒë·ªß th√¥ng tin
        const inputs = [document.getElementById('expense-description'), document.getElementById('expense-amount')];
        inputs.forEach(input => {
          input.classList.add('animate__animated', 'animate__shakeX');
          setTimeout(() => {
            input.classList.remove('animate__animated', 'animate__shakeX');
          }, 1000);
        });
        alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin chi ph√≠!');
      }
    }

    // Ch·ªânh s·ª≠a chi ph√≠
    function editExpense(index) {
      const expense = expenses[index];
      const li = document.getElementById(`expense-item-${index}`);
      li.innerHTML = `
        <div class="flex items-center justify-between p-2 rounded-lg bg-white">
          <div class="flex-1 flex space-x-2">
            <input id="edit-description-${index}" type="text" value="${expense.description}" 
                   class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-400 focus:outline-none">
            <input id="edit-amount-${index}" type="number" value="${expense.amount}" 
                   class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-400 focus:outline-none">
          </div>
          <div class="flex space-x-1">
            <button onclick="saveExpense(${index})" class="btn bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded-lg text-sm">
              <i class="fas fa-save"></i>
            </button>
            <button onclick="updateExpenseList()" class="btn bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded-lg text-sm">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      `;
    }

    // L∆∞u chi ph√≠ ƒë√£ ch·ªânh s·ª≠a
    function saveExpense(index) {
      const newDescription = document.getElementById(`edit-description-${index}`).value.trim();
      const newAmount = parseFloat(document.getElementById(`edit-amount-${index}`).value);
      if (newDescription && newAmount > 0) {
        expenses[index] = { description: newDescription, amount: newAmount };
        localStorage.setItem('expenses', JSON.stringify(expenses));
        updateExpenseList();
      } else {
        // Hi·ªáu ·ª©ng l·∫Øc khi kh√¥ng nh·∫≠p ƒë·ªß th√¥ng tin
        const inputs = [document.getElementById(`edit-description-${index}`), document.getElementById(`edit-amount-${index}`)];
        inputs.forEach(input => {
          input.classList.add('animate__animated', 'animate__shakeX');
          setTimeout(() => {
            input.classList.remove('animate__animated', 'animate__shakeX');
          }, 1000);
        });
        alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin chi ph√≠!');
      }
    }

    // X√≥a chi ph√≠
    function deleteExpense(index) {
      // Hi·ªáu ·ª©ng x√≥a
      const item = document.getElementById(`expense-item-${index}`);
      item.classList.add('animate__animated', 'animate__hinge');
      
      setTimeout(() => {
        expenses.splice(index, 1);
        localStorage.setItem('expenses', JSON.stringify(expenses));
        updateExpenseList();
      }, 1000);
    }

    // C·∫≠p nh·∫≠t danh s√°ch thu chi
    function updateExpenseList() {
      const expenseList = document.getElementById('expense-list');
      expenseList.innerHTML = '';
      let total = 0;
      expenses.forEach((expense, index) => {
        const li = document.createElement('li');
        li.id = `expense-item-${index}`;
        li.className = 'expense-item p-3 rounded-lg bg-white shadow-sm';
        li.innerHTML = `
          <div class="expense-info">
            <i class="fas fa-receipt text-blue-500"></i>
            <div>
              <div class="font-medium">${expense.description}</div>
              <div class="text-sm text-gray-500">${formatNumber(expense.amount)} VND</div>
            </div>
          </div>
          <div class="expense-actions">
            <button onclick="editExpense(${index})" class="btn bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded-lg">
              <i class="fas fa-edit"></i>
            </button>
            <button onclick="deleteExpense(${index})" class="btn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded-lg">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        li.classList.add('animate__animated', 'animate__fadeIn');
        expenseList.appendChild(li);
        total += expense.amount;
      });

      // C·∫≠p nh·∫≠t t·ªïng chi ph√≠
      const totalElement = document.getElementById('total-expense');
      totalElement.innerHTML = `
        <i class="fas fa-wallet text-purple-500 mr-2"></i>
        T·ªïng c·ªông: <span class="text-purple-600">${formatNumber(total)} VND</span>
      `;
      totalElement.classList.add('animate__animated', 'animate__pulse');
      setTimeout(() => {
        totalElement.classList.remove('animate__animated', 'animate__pulse');
      }, 500);

      // T√≠nh s·ªë ti·ªÅn m·ªói ng∆∞·ªùi ph·∫£i ƒë√≥ng
      const numberOfParticipants = parseInt(document.getElementById('number-of-participants').value) || 0;
      const perPersonExpense = numberOfParticipants > 0 ? Math.round(total / numberOfParticipants) : 0;
      const perPersonElement = document.getElementById('per-person-expense');
      perPersonElement.innerHTML = numberOfParticipants > 0
        ? `
          <i class="fas fa-user-friends text-green-500 mr-2"></i>
          M·ªói ng∆∞·ªùi ph·∫£i ƒë√≥ng: <span class="text-green-600">${formatNumber(perPersonExpense)} VND</span>
          <span class="text-sm text-gray-500">(${numberOfParticipants} ng∆∞·ªùi)</span>
        `
        : '<i class="fas fa-exclamation-circle text-yellow-500 mr-2"></i> Vui l√≤ng nh·∫≠p s·ªë ng∆∞·ªùi tham gia ƒÉn.';
    }
    
    // T·∫°o hi·ªáu ·ª©ng m√≥n ƒÉn n·ªïi
    function createFloatingFoods() {
      const foods = ['üçú', 'üç≤', 'üçõ', 'üç±', 'ü•ò', 'üçù', 'üç£', 'üç§', 'üçï', 'üåÆ'];
      const app = document.getElementById('app');
      
      foods.forEach((food, index) => {
        const element = document.createElement('div');
        element.className = 'floating-food';
        element.textContent = food;
        element.style.top = Math.random() * 100 + '%';
        element.style.animationDuration = Math.random() * 10 + 10 + 's';
        element.style.animationDelay = Math.random() * 5 + 's';
        app.appendChild(element);
      });
    }
    
    // Kh·ªüi t·∫°o hi·ªáu ·ª©ng khi trang load
    window.onload = function() {
      createFloatingFoods();
    };
  </script>
</body>
</html>

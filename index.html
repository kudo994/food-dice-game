<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tr√≤ Ch∆°i VPIC ƒê·ªï X√∫c X·∫Øc Ch·ªçn M√≥n ƒÇn Tr∆∞a</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0;
      padding: 20px;
    }
    #app {
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      width: 100%;
      max-width: 500px;
      position: relative;
      overflow: hidden;
    }
    #dice-container {
      width: 150px;
      height: 150px;
      margin: 0 auto;
    }
    #food-chart {
      width: 100%;
      height: 200px;
      background: #f8f9fa;
      border-radius: 10px;
      padding: 10px;
    }
    #reset-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(45deg, #ff4d4d, #ff7878);
      color: white;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(255, 77, 77, 0.3);
      transition: transform 0.2s ease;
    }
    #reset-button:hover {
      transform: scale(1.1);
      background: linear-gradient(45deg, #ff7878, #ff4d4d);
    }
    .btn {
      transition: all 0.3s ease;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .screen {
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    .screen.hidden {
      opacity: 0;
      transform: translateY(20px);
      pointer-events: none;
    }
    .list-item {
      transition: all 0.3s ease;
    }
    .list-item:hover {
      background-color: #f1f5f9;
      transform: translateX(5px);
    }
    h1, h2 {
      color: #2d3748;
    }
    input, button {
      border-radius: 10px !important;
    }
    /* Hi·ªáu ·ª©ng nh·∫•p nh√°y */
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    .blink {
      animation: blink 2s infinite;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- M√†n h√¨nh ƒëƒÉng nh·∫≠p -->
    <div id="login-screen" class="screen space-y-6">
      <h1 class="text-3xl font-bold text-center text-gray-800">Ch√†o M·ª´ng ƒê·∫øn V·ªõi Tr√≤ Ch∆°i Tr∆∞a Mai ƒê·ªõp G√¨?</h1>
      <p class="blink text-sm italic text-center text-yellow-500">M·ªôt con game B·ªë ƒê·ªùi do Mr √Ånh #07897 ph√°t tri·ªÉn üòé</p>
      <input id="player-name" type="text" placeholder="N√©m c√°i t√™n c√∫ng c∆°m v√†o ƒë√¢y" class="w-full p-3 border border-gray-300 focus:ring-2 focus:ring-blue-400 focus:outline-none">
      <button onclick="login()" class="btn w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700">B·∫Øt ƒë·∫ßu Th·ª≠ V·∫≠n May</button>
    </div>

    <!-- M√†n h√¨nh ch√≠nh -->
    <div id="main-screen" class="screen hidden space-y-6">
      <h1 class="text-3xl font-bold text-center text-gray-800">TH√äM M√ìN & ƒê·ªî X√öC X·∫ÆC ƒê·ªÇ QUY·∫æT ƒê·ªäNH B·ªÆA TR∆ØA B·∫∞NG NH√ÇN PH·∫®M üëá</h1>
      <p id="welcome-message" class="text-center text-gray-600"></p>
      <div id="dice-container" class="relative"></div>
      <button onclick="rollDice()" class="btn w-full bg-green-600 text-white p-3 rounded-lg hover:bg-green-700">ƒê·ªï X√∫c X·∫Øc</button>
      <p id="result" class="text-center font-semibold text-lg text-gray-700"></p>
      <div class="space-y-3">
        <input id="new-food" type="text" placeholder="Th√™m m√≥n ƒÉn m·ªõi" class="w-full p-3 border border-gray-300 focus:ring-2 focus:ring-purple-400 focus:outline-none">
        <button onclick="addFood()" class="btn w-full bg-purple-600 text-white p-3 rounded-lg hover:bg-purple-700">Th√™m M√≥n</button>
      </div>
      <h2 class="text-xl font-semibold text-gray-700">Danh S√°ch M√≥n ƒÇn</h2>
      <ul id="food-list" class="list-disc pl-5 space-y-2"></ul>
      <h2 class="text-xl font-semibold text-gray-700">L·ªãch S·ª≠ Ch·ªçn M√≥n</h2>
      <ul id="history" class="list-disc pl-5 space-y-2"></ul>
      <h2 class="text-xl font-semibold text-gray-700">Th·ªëng K√™ M√≥n ƒÇn</h2>
      <p id="most-selected-food" class="blink text-lg font-bold text-center text-red-600 bg-yellow-100 p-3 rounded-lg"></p>
      <div class="flex space-x-3">
        <button onclick="showTop5Foods()" class="btn w-full bg-gray-600 text-white p-2 rounded-lg hover:bg-gray-700">Top 5 M√≥n</button>
        <button onclick="showAllFoods()" class="btn w-full bg-gray-600 text-white p-2 rounded-lg hover:bg-gray-700">Hi·ªÉn Th·ªã T·∫•t C·∫£</button>
      </div>
      <canvas id="food-chart"></canvas>
      <div class="flex space-x-3">
        <button onclick="goToFinance()" class="btn w-full bg-yellow-600 text-white p-3 rounded-lg hover:bg-yellow-700">T·ªîNG THI·ªÜT H·∫†I üí∏</button>
      </div>
      <div id="reset-button" onclick="resetGame()" title="L√†m m·ªõi">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9H0m0 0v5h4.582M12 4a8 8 0 110 16 8 8 0 010-16z"></path>
        </svg>
      </div>
    </div>

    <!-- M√†n h√¨nh thu chi -->
    <div id="finance-screen" class="screen hidden space-y-6">
      <h1 class="text-3xl font-bold text-center text-gray-800">Li·ªát K√™ H·∫≠u Qu·∫£</h1>
      <div class="space-y-3">
        <input id="expense-description" type="text" placeholder="M√¥ t·∫£ nguy√™n v·∫≠t li·ªáu" class="w-full p-3 border border-gray-300 focus:ring-2 focus:ring-purple-400 focus:outline-none">
        <input id="expense-amount" type="number" placeholder="S·ªë ti·ªÅn (VND)" class="w-full p-3 border border-gray-300 focus:ring-2 focus:ring-purple-400 focus:outline-none">
        <button onclick="addExpense()" class="btn w-full bg-purple-600 text-white p-3 rounded-lg hover:bg-purple-700">Th√™m Chi Ph√≠</button>
      </div>
      <div class="space-y-3">
        <input id="number-of-participants" type="number" placeholder="S·ªë ng∆∞·ªùi tham gia ƒÉn" class="w-full p-3 border border-gray-300 focus:ring-2 focus:ring-blue-400 focus:outline-none" min="1">
      </div>
      <h2 class="text-xl font-semibold text-gray-700">Th·ªëng K√™ Thu Chi</h2>
      <ul id="expense-list" class="list-disc pl-5 space-y-2"></ul>
      <p id="total-expense" class="text-center font-bold text-gray-800"></p>
      <p id="per-person-expense" class="text-center font-medium text-gray-600"></p>
      <button onclick="goToMain()" class="btn w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700">Quay L·∫°i</button>
    </div>
  </div>

  <script>
    const socket = io('https://treasure-rightful-scallion.glitch.me');

    let playerName = '';
    let foods = [];
    let history = [];
    let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
    let foodResults = {};
    let foodChart;
    let showingTop5 = false;

    // Nh·∫≠n d·ªØ li·ªáu ban ƒë·∫ßu t·ª´ server
    socket.on('initData', (data) => {
      foods = data.foods;
      history = data.history;
      foodResults = data.foodResults;
      updateFoodList();
      updateHistory();
      if (foodChart) {
        updateFoodChart();
      }
    });

    // Nh·∫≠n c·∫≠p nh·∫≠t t·ª´ server
    socket.on('updateFoods', (newFoods) => {
      foods = newFoods;
      updateFoodList();
      updateFoodChart();
    });

    socket.on('updateHistory', (newHistory) => {
      history = newHistory;
      updateHistory();
    });

    socket.on('updateFoodResults', (newFoodResults) => {
      foodResults = newFoodResults;
      updateFoodChart();
    });

    // Kh·ªüi t·∫°o foodResults
    function initFoodResults() {
      foods.forEach(food => {
        if (!(food.name in foodResults)) {
          foodResults[food.name] = 0;
        }
      });
    }

    // Three.js setup for 3D dice
    let scene, camera, renderer, dice;
    let isRolling = false;

    function initDice() {
      const container = document.getElementById('dice-container');
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, 150 / 150, 0.1, 1000);
      renderer = new THREE.WebGLRenderer({ alpha: true });
      renderer.setSize(150, 150);
      container.appendChild(renderer.domElement);

      // √Ånh s√°ng
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambientLight);
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(0, 1, 1);
      scene.add(directionalLight);

      // X√∫c x·∫Øc v·ªõi texture
      const geometry = new THREE.BoxGeometry(1, 1, 1);
      const material = new THREE.MeshPhongMaterial({ color: 0xffffff, shininess: 100 });
      dice = new THREE.Mesh(geometry, material);
      scene.add(dice);

      // Th√™m ch·∫•m tr√™n x√∫c x·∫Øc
      const dotGeometry = new THREE.SphereGeometry(0.05, 16, 16);
      const dotMaterial = new THREE.MeshBasicMaterial({ color: 0x000000 });

      const dot1 = new THREE.Mesh(dotGeometry, dotMaterial);
      dot1.position.set(0, 0, 0.51);
      dice.add(dot1);

      const dot2a = new THREE.Mesh(dotGeometry, dotMaterial);
      dot2a.position.set(-0.2, 0.2, -0.51);
      const dot2b = new THREE.Mesh(dotGeometry, dotMaterial);
      dot2b.position.set(0.2, -0.2, -0.51);
      dice.add(dot2a);
      dice.add(dot2b);

      const dot3a = new THREE.Mesh(dotGeometry, dotMaterial);
      dot3a.position.set(-0.2, 0.2, 0.51);
      const dot3b = new THREE.Mesh(dotGeometry, dotMaterial);
      dot3b.position.set(0, 0, 0.51);
      const dot3c = new THREE.Mesh(dotGeometry, dotMaterial);
      dot3c.position.set(0.2, -0.2, 0.51);
      dice.add(dot3a);
      dice.add(dot3b);
      dice.add(dot3c);

      const dot4a = new THREE.Mesh(dotGeometry, dotMaterial);
      dot4a.position.set(-0.2, 0.2, -0.51);
      const dot4b = new THREE.Mesh(dotGeometry, dotMaterial);
      dot4b.position.set(0.2, 0.2, -0.51);
      const dot4c = new THREE.Mesh(dotGeometry, dotMaterial);
      dot4c.position.set(-0.2, -0.2, -0.51);
      const dot4d = new THREE.Mesh(dotGeometry, dotMaterial);
      dot4d.position.set(0.2, -0.2, -0.51);
      dice.add(dot4a);
      dice.add(dot4b);
      dice.add(dot4c);
      dice.add(dot4d);

      const dot5a = new THREE.Mesh(dotGeometry, dotMaterial);
      dot5a.position.set(-0.2, 0.2, 0.51);
      const dot5b = new THREE.Mesh(dotGeometry, dotMaterial);
      dot5b.position.set(0.2, 0.2, 0.51);
      const dot5c = new THREE.Mesh(dotGeometry, dotMaterial);
      dot5c.position.set(0, 0, 0.51);
      const dot5d = new THREE.Mesh(dotGeometry, dotMaterial);
      dot5d.position.set(-0.2, -0.2, 0.51);
      const dot5e = new THREE.Mesh(dotGeometry, dotMaterial);
      dot5e.position.set(0.2, -0.2, 0.51);
      dice.add(dot5a);
      dice.add(dot5b);
      dice.add(dot5c);
      dice.add(dot5d);
      dice.add(dot5e);

      const dot6a = new THREE.Mesh(dotGeometry, dotMaterial);
      dot6a.position.set(-0.2, 0.2, -0.51);
      const dot6b = new THREE.Mesh(dotGeometry, dotMaterial);
      dot6b.position.set(0.2, 0.2, -0.51);
      const dot6c = new THREE.Mesh(dotGeometry, dotMaterial);
      dot6c.position.set(-0.2, 0, -0.51);
      const dot6d = new THREE.Mesh(dotGeometry, dotMaterial);
      dot6d.position.set(0.2, 0, -0.51);
      const dot6e = new THREE.Mesh(dotGeometry, dotMaterial);
      dot6e.position.set(-0.2, -0.2, -0.51);
      const dot6f = new THREE.Mesh(dotGeometry, dotMaterial);
      dot6f.position.set(0.2, -0.2, -0.51);
      dice.add(dot6a);
      dice.add(dot6b);
      dice.add(dot6c);
      dice.add(dot6d);
      dice.add(dot6e);
      dice.add(dot6f);

      camera.position.z = 2;
      animateDice();
    }

    function animateDice() {
      requestAnimationFrame(animateDice);
      renderer.render(scene, camera);
    }

    function rollDiceAnimation(finalFace) {
      if (isRolling) return;
      isRolling = true;
      let rollTime = 0;
      const rollDuration = 1000;
      const rollInterval = setInterval(() => {
        rollTime += 16;
        dice.rotation.x += Math.random() * 0.5;
        dice.rotation.y += Math.random() * 0.5;
        if (rollTime >= rollDuration) {
          clearInterval(rollInterval);
          switch (finalFace) {
            case 1:
              dice.rotation.x = 0;
              dice.rotation.y = 0;
              break;
            case 2:
              dice.rotation.x = Math.PI;
              dice.rotation.y = 0;
              break;
            case 3:
              dice.rotation.x = Math.PI / 2;
              dice.rotation.y = 0;
              break;
            case 4:
              dice.rotation.x = -Math.PI / 2;
              dice.rotation.y = 0;
              break;
            case 5:
              dice.rotation.x = 0;
              dice.rotation.y = Math.PI / 2;
              break;
            case 6:
              dice.rotation.x = 0;
              dice.rotation.y = -Math.PI / 2;
              break;
          }
          isRolling = false;
        }
      }, 16);
    }

    // Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì m√≥n ƒÉn
    function initFoodChart() {
      const ctx = document.getElementById('food-chart').getContext('2d');
      foodChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(foodResults),
          datasets: [{
            label: 'S·ªë l·∫ßn ƒë∆∞·ª£c ch·ªçn',
            data: Object.values(foodResults),
            backgroundColor: [
              'rgba(255, 99, 132, 0.7)',
              'rgba(54, 162, 235, 0.7)',
              'rgba(255, 206, 86, 0.7)',
              'rgba(75, 192, 192, 0.7)',
              'rgba(153, 102, 255, 0.7)',
              'rgba(255, 159, 64, 0.7)'
            ].slice(0, Object.keys(foodResults).length),
            borderColor: [
              'rgba(255, 99, 132, 1)',
              'rgba(54, 162, 235, 1)',
              'rgba(255, 206, 86, 1)',
              'rgba(75, 192, 192, 1)',
              'rgba(153, 102, 255, 1)',
              'rgba(255, 159, 64, 1)'
            ].slice(0, Object.keys(foodResults).length),
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'S·ªë l·∫ßn ƒë∆∞·ª£c ch·ªçn',
                font: { family: 'Poppins', size: 14 }
              }
            },
            x: {
              title: {
                display: true,
                text: 'M√≥n ƒÉn',
                font: { family: 'Poppins', size: 14 }
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: true,
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.raw} l·∫ßn`;
                }
              }
            }
          }
        }
      });
    }

    // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì m√≥n ƒÉn v√† th√¥ng b√°o m√≥n ƒÉn ƒë∆∞·ª£c ch·ªçn nhi·ªÅu nh·∫•t
    function updateFoodChart() {
      let labels = Object.keys(foodResults);
      let data = Object.values(foodResults);

      if (showingTop5) {
        const sortedFoods = Object.entries(foodResults)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);
        labels = sortedFoods.map(entry => entry[0]);
        data = sortedFoods.map(entry => entry[1]);
      }

      foodChart.data.labels = labels;
      foodChart.data.datasets[0].data = data;
      foodChart.data.datasets[0].backgroundColor = [
        'rgba(255, 99, 132, 0.7)',
        'rgba(54, 162, 235, 0.7)',
        'rgba(255, 206, 86, 0.7)',
        'rgba(75, 192, 192, 0.7)',
        'rgba(153, 102, 255, 0.7)',
        'rgba(255, 159, 64, 0.7)'
      ].slice(0, labels.length);
      foodChart.data.datasets[0].borderColor = [
        'rgba(255, 99, 132, 1)',
        'rgba(54, 162, 235, 1)',
        'rgba(255, 206, 86, 1)',
        'rgba(75, 192, 192, 1)',
        'rgba(153, 102, 255, 1)',
        'rgba(255, 159, 64, 1)'
      ].slice(0, labels.length);
      foodChart.update();

      // C·∫≠p nh·∫≠t th√¥ng b√°o m√≥n ƒÉn ƒë∆∞·ª£c ch·ªçn nhi·ªÅu nh·∫•t
      const mostSelectedFood = Object.entries(foodResults)
        .sort((a, b) => b[1] - a[1])[0];
      const mostSelectedMessage = mostSelectedFood && mostSelectedFood[1] > 0
        ? `M√≥n ƒÉn ƒë∆∞·ª£c ch·ªçn tr√∫ng nhi·ªÅu nh·∫•t cho b·ªØa tr∆∞a mai l√† ${mostSelectedFood[0]} üéâ`
        : 'Ch∆∞a c√≥ m√≥n ƒÉn n√†o ƒë∆∞·ª£c ch·ªçn.';
      document.getElementById('most-selected-food').textContent = mostSelectedMessage;
    }

    // Hi·ªÉn th·ªã top 5 m√≥n ƒÉn
    function showTop5Foods() {
      showingTop5 = true;
      updateFoodChart();
    }

    // Hi·ªÉn th·ªã t·∫•t c·∫£ m√≥n ƒÉn
    function showAllFoods() {
      showingTop5 = false;
      updateFoodChart();
    }

    // M√†n h√¨nh ƒëƒÉng nh·∫≠p
    function login() {
      const nameInput = document.getElementById('player-name').value.trim();
      if (nameInput) {
        playerName = nameInput;
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-screen').classList.remove('hidden');
        document.getElementById('welcome-message').textContent = `Ch√†o ${playerName}!`;
        initFoodResults();
        updateFoodList();
        updateHistory();
        initDice();
        initFoodChart();
        updateFoodChart();
      } else {
        alert('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!');
      }
    }

    // C·∫≠p nh·∫≠t danh s√°ch m√≥n ƒÉn
    function updateFoodList() {
      const foodList = document.getElementById('food-list');
      foodList.innerHTML = '';
      foods.forEach((food, index) => {
        const li = document.createElement('li');
        li.className = 'list-item flex justify-between items-center p-2 rounded-lg';
        li.innerHTML = `
          ${food.name} (ƒê∆∞·ª£c th√™m b·ªüi ${food.addedBy})
          <button onclick="deleteFood(${index})" class="btn bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600">X√≥a</button>
        `;
        li.classList.add('animate__animated', 'animate__fadeIn');
        foodList.appendChild(li);
      });
    }

    // X√≥a m√≥n ƒÉn
    function deleteFood(index) {
      const foodToDelete = foods[index].name;
      
      foods.splice(index, 1);
      history = history.filter(entry => {
        const match = entry.match(/(.+?) \(b·ªüi (.+)\)/);
        return match ? match[1] !== foodToDelete : true;
      });
      delete foodResults[foodToDelete];

      socket.emit('updateFoods', foods);
      socket.emit('updateHistory', history);
      socket.emit('updateFoodResults', foodResults);

      if (document.getElementById('result').textContent.includes(foodToDelete)) {
        document.getElementById('result').textContent = '';
      }
    }

    // ƒê·ªï x√∫c x·∫Øc v·ªõi hi·ªáu ·ª©ng
    function rollDice() {
      if (foods.length === 0) {
        alert('H√£y th√™m √≠t nh·∫•t m·ªôt m√≥n ƒÉn!');
        return;
      }
      const randomFace = Math.floor(Math.random() * 6) + 1;
      rollDiceAnimation(randomFace);
      setTimeout(() => {
        const randomIndex = Math.floor(Math.random() * foods.length);
        const selectedFood = foods[randomIndex].name;
        foodResults[selectedFood] = (foodResults[selectedFood] || 0) + 1;
        history.push(`${selectedFood} (b·ªüi ${playerName})`);
        document.getElementById('result').textContent = `M√≥n ƒÉn b·∫°n ch·ªçn tr√∫ng l√†: ${selectedFood}`;
        document.getElementById('result').classList.add('animate__animated', 'animate__bounceIn');

        socket.emit('updateHistory', history);
        socket.emit('updateFoodResults', foodResults);
      }, 1000);
    }

    // C·∫≠p nh·∫≠t l·ªãch s·ª≠
    function updateHistory() {
      const historyList = document.getElementById('history');
      historyList.innerHTML = '';
      history.forEach(item => {
        const li = document.createElement('li');
        li.className = 'list-item p-2 rounded-lg';
        li.textContent = item;
        li.classList.add('animate__animated', 'animate__fadeIn');
        historyList.appendChild(li);
      });
    }

    // Th√™m m√≥n ƒÉn
    function addFood() {
      const newFood = document.getElementById('new-food').value.trim();
      if (newFood) {
        if (foods.some(food => food.name === newFood)) {
          alert('M√≥n ƒÉn n√†y ƒë√£ c√≥ trong danh s√°ch!');
          return;
        }
        const foodEntry = { name: newFood, addedBy: playerName };
        foods.push(foodEntry);
        if (!(newFood in foodResults)) {
          foodResults[newFood] = 0;
        }
        document.getElementById('new-food').value = '';

        socket.emit('updateFoods', foods);
        socket.emit('updateFoodResults', foodResults);
      } else {
        alert('Vui l√≤ng nh·∫≠p t√™n m√≥n ƒÉn!');
      }
    }

    // L√†m m·ªõi game
    function resetGame() {
      foods = [];
      history = [];
      expenses = [];
      foodResults = {};
      
      socket.emit('updateFoods', foods);
      socket.emit('updateHistory', history);
      socket.emit('updateFoodResults', foodResults);

      localStorage.setItem('expenses', JSON.stringify(expenses));
      document.getElementById('result').textContent = '';
      location.reload();
    }

    // Chuy·ªÉn sang m√†n h√¨nh thu chi
    function goToFinance() {
      document.getElementById('main-screen').classList.add('hidden');
      document.getElementById('finance-screen').classList.remove('hidden');
      updateExpenseList();
    }

    // Quay l·∫°i m√†n h√¨nh ch√≠nh
    function goToMain() {
      document.getElementById('finance-screen').classList.add('hidden');
      document.getElementById('main-screen').classList.remove('hidden');
      updateFoodChart();
    }

    // ƒê·ªãnh d·∫°ng s·ªë ti·ªÅn v·ªõi d·∫•u ch·∫•m ph√¢n c√°ch
    function formatNumber(number) {
      return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    // Th√™m chi ph√≠
    function addExpense() {
      const description = document.getElementById('expense-description').value.trim();
      const amount = parseFloat(document.getElementById('expense-amount').value);
      if (description && amount > 0) {
        expenses.push({ description, amount });
        document.getElementById('expense-description').value = '';
        document.getElementById('expense-amount').value = '';
        updateExpenseList();
        localStorage.setItem('expenses', JSON.stringify(expenses));
      } else {
        alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin chi ph√≠!');
      }
    }

    // Ch·ªânh s·ª≠a chi ph√≠
    function editExpense(index) {
      const expense = expenses[index];
      const li = document.getElementById(`expense-item-${index}`);
      li.innerHTML = `
        <div class="flex items-center justify-between p-2 rounded-lg">
          <div class="flex-1 flex space-x-2">
            <input id="edit-description-${index}" type="text" value="${expense.description}" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-400 focus:outline-none w-1/2">
            <input id="edit-amount-${index}" type="number" value="${expense.amount}" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-400 focus:outline-none w-1/2">
          </div>
          <div class="flex space-x-1">
            <button onclick="saveExpense(${index})" class="btn bg-green-500 text-white px-2 py-1 rounded-lg hover:bg-green-600 text-sm">L∆∞u</button>
            <button onclick="updateExpenseList()" class="btn bg-gray-500 text-white px-2 py-1 rounded-lg hover:bg-gray-600 text-sm">H·ªßy</button>
          </div>
        </div>
      `;
    }

    // L∆∞u chi ph√≠ ƒë√£ ch·ªânh s·ª≠a
    function saveExpense(index) {
      const newDescription = document.getElementById(`edit-description-${index}`).value.trim();
      const newAmount = parseFloat(document.getElementById(`edit-amount-${index}`).value);
      if (newDescription && newAmount > 0) {
        expenses[index] = { description: newDescription, amount: newAmount };
        localStorage.setItem('expenses', JSON.stringify(expenses));
        updateExpenseList();
      } else {
        alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin chi ph√≠!');
      }
    }

    // X√≥a chi ph√≠
    function deleteExpense(index) {
      expenses.splice(index, 1);
      localStorage.setItem('expenses', JSON.stringify(expenses));
      updateExpenseList();
    }

    // C·∫≠p nh·∫≠t danh s√°ch thu chi
    function updateExpenseList() {
      const expenseList = document.getElementById('expense-list');
      expenseList.innerHTML = '';
      let total = 0;
      expenses.forEach((expense, index) => {
        const li = document.createElement('li');
        li.id = `expense-item-${index}`;
        li.className = 'list-item flex justify-between items-center p-2 rounded-lg';
        li.innerHTML = `
          <div class="flex-1">${expense.description}: ${formatNumber(expense.amount)} VND</div>
          <div class="flex space-x-1">
            <button onclick="editExpense(${index})" class="btn bg-blue-500 text-white px-2 py-1 rounded-lg hover:bg-blue-600 text-sm">S·ª¨A</button>
            <button onclick="deleteExpense(${index})" class="btn bg-red-500 text-white px-2 py-1 rounded-lg hover:bg-red-600 text-sm">X√ìA</button>
          </div>
        `;
        li.classList.add('animate__animated', 'animate__fadeIn');
        expenseList.appendChild(li);
        total += expense.amount;
      });

      // C·∫≠p nh·∫≠t t·ªïng chi ph√≠
      document.getElementById('total-expense').textContent = `T·ªïng c·ªông: ${formatNumber(total)} VND`;

      // T√≠nh s·ªë ti·ªÅn m·ªói ng∆∞·ªùi ph·∫£i ƒë√≥ng
      const numberOfParticipants = parseInt(document.getElementById('number-of-participants').value) || 0;
      const perPersonExpense = numberOfParticipants > 0 ? Math.round(total / numberOfParticipants) : 0;
      document.getElementById('per-person-expense').textContent = numberOfParticipants > 0
        ? `M·ªói ng∆∞·ªùi ph·∫£i ƒë√≥ng: ${formatNumber(perPersonExpense)} VND (${numberOfParticipants} ng∆∞·ªùi)`
        : 'Vui l√≤ng nh·∫≠p s·ªë ng∆∞·ªùi tham gia ƒÉn.';
    }
  </script>
</body>
</html>
